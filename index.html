<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ø±ÙÙŠÙ‚ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ</title>

  <link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Reem+Kufi+Fun:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#140141;
      --bg2:#0b5757;
      --bg3:#030e0b;
      --card:rgba(8, 4, 48, 0.62);
      --stroke:rgba(15,23,42,.12);
      --text:#0f172a;
      --muted:rgba(15,23,42,.62);
      --gold:#d4af37;
      --shadow: 0 14px 40px rgba(2,6,23,.08);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: 'El Messiri', sans-serif;
      color:var(--text);
      background: linear-gradient(160deg, var(--bg1), var(--bg2), var(--bg3));
      min-height:100vh;
    }
    a,button,input{ font-family:inherit; }
    .wrap{ max-width: 1040px; margin: 0 auto; padding: 22px 16px 50px; }

    .authBtn{
      width:100%;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(16,185,129,.35);
      background: linear-gradient(135deg, rgba(16,185,129,.15), rgba(212,175,55,.15));
      backdrop-filter: blur(6px);
      font-weight: 800;
      font-size: 14px;
      color: rgba(15,23,42,.9);
      cursor:pointer;
      transition: all .25s ease;
      box-shadow: 0 12px 30px rgba(2,6,23,.06);
    }
    .authBtn:hover{
      transform: translateY(-2px);
      box-shadow: 0 18px 35px rgba(2,6,23,.10);
      background: linear-gradient(135deg, rgba(16,185,129,.25), rgba(212,175,55,.25));
    }
    .authBtn:active{ transform: scale(.98); }
    .authBtn:disabled{ opacity:.65; cursor:not-allowed; transform:none; }

    .pillbar{
      display:flex;
      gap:5px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top: 8px;
    }
    .pill{
      background: rgba(255,255,255,.55);
      padding: 8px 12px;
      border-radius: 999px;
      box-shadow: 0 8px 20px rgba(2,6,23,.04);
      font-size: 12px;
      color: rgba(15,23,42,.75);
      display:flex; align-items:center; gap:8px;
    }
    .toolbarBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding: 10px 16px;
      min-height: 42px;
      border-radius: 999px;
      border: 0;
      background: rgba(255, 255, 255, 0.11);
      backdrop-filter: blur(6px);
      font-weight: 700;
      font-size: 14px;
      color: rgba(255,255,255,.92);
      cursor:pointer;
      transition: all .25s ease;
      box-shadow: 0 8px 24px rgba(2,6,23,.05);
    }
    .toolbarBtn:hover{
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.151);
      box-shadow: 0 14px 30px rgba(2,6,23,.08);
    }
    .toolbarBtn:active{ transform: scale(.98); }
    .toolbarBtn.danger{
      background: rgba(239,68,68,.10);
      color: rgba(255,255,255,.92);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(circle at 12% 20%, rgba(212,175,55,.22), transparent 55%),
        radial-gradient(circle at 86% 30%, rgba(16,185,129,.18), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }
    .card > *{ position:relative; }
    .cardHead{
      padding: 16px 16px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap: 12px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.22);
    }
    .cardTitle{ margin:0; font-size: 15px; color: rgba(255,255,255,.92); }
    .cardSub{ margin:6px 0 0; color: rgba(255,255,255,.72); font-size: 12px; line-height:1.6; }
    .cardBody{ padding: 14px 16px 16px; }

    .authBox{ max-width: 520px; margin: 18px auto 0; }
    .authTabs{ display:flex; gap:10px; padding: 10px; }
    .tab{
      flex:1;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.55);
      cursor:pointer;
      font-weight:700;
      color: rgba(15,23,42,.78);
      transition: background .2s ease;
    }
    .tab.active{
      background: rgba(16,185,129,.12);
      border-color: rgba(16,185,129,.28);
    }
    .form{ padding: 14px 16px 16px; display:grid; gap: 10px; }
    .field{ display:grid; gap: 6px; }
    label{ font-size: 12px; color: rgba(255,255,255,.78); }
    input{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.22);
      outline: none;
      background: rgba(255,255,255,.82);
      transition: box-shadow .2s ease, border-color .2s ease;
    }
    input:focus{
      border-color: rgba(16,185,129,.45);
      box-shadow: 0 0 0 4px rgba(16,185,129,.14);
    }
    .row{ display:flex; gap: 10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .hint{ font-size: 12px; color: rgba(255,255,255,.72); line-height:1.6; }

    .msg{
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.55);
      font-size: 12px;
      color: rgba(15,23,42,.85);
      display:none;
    }
    .msg.show{ display:block; }

    .toast{
      position: fixed;
      inset: auto 16px 16px 16px;
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index: 50;
    }
    .toast > div{
      max-width: 520px;
      width: 100%;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(16,185,129,.25);
      background: rgba(255,255,255,.85);
      box-shadow: 0 18px 40px rgba(2,6,23,.12);
      font-size: 13px;
      color: rgba(15,23,42,.88);
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease;
    }
    .toast.show > div{ opacity: 1; transform: translateY(0px); }

    .progressWrap{ display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap:wrap; margin-bottom: 12px; }
    .progressBar{
      width:100%;
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.20);
      overflow:hidden;
    }
    .progressFill{
      height:100%;
      width:0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(16,185,129,.65), rgba(212,175,55,.45));
      box-shadow: 0 0 24px rgba(16,185,129,.18);
      transition: width .35s ease;
    }

    .juzGrid{ display:grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 10px; }
    @media (max-width: 520px){ .juzGrid{ grid-template-columns: repeat(5, minmax(0, 1fr)); } }

    .juzBtn{
      border-radius: 18px;
      padding: 12px 10px;
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.55);
      transition: transform .12s ease, box-shadow .25s ease, background .25s ease, border-color .25s ease;
      overflow:hidden;
      min-height: 68px;
    }
    .juzBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.72); box-shadow: 0 14px 30px rgba(2,6,23,.08); }
    .juzBtn:active{ transform: translateY(0px) scale(.99); }
    .juzBtn .small{ font-size: 11px; color: rgba(15,23,42,.55); }
    .juzBtn .num{ font-weight: 800; font-size: 18px; margin-top: 4px; }
    .juzBtn.done{
      background: rgba(16,185,129,.12);
      border-color: rgba(16,185,129,.28);
      box-shadow: 0 0 28px rgba(16,185,129,.16);
    }

    .lbList{ display:grid; gap: 10px; }
    .lbRow{
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.5);
    }
    .lbLeft{ display:flex; align-items:center; gap: 10px; }
    .rank{
      width: 30px; height: 30px;
      border-radius: 999px;
      display:grid; place-items:center;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.65);
      font-weight: 800;
      color: rgba(15,23,42,.78);
    }
    .name{ font-weight: 800; font-size: 13px; }
    .meta{ font-size: 11px; color: rgba(15,23,42,.62); margin-top: 2px; }

    .khatmaTag{
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      min-width: 56px;
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid rgba(212,175,55,.28);
      background: rgba(212,175,55,.10);
    }
    .khatmaTag .crown{ font-size: 16px; line-height: 1; }
    .khatmaTag .num{ font-weight: 900; font-size: 14px; color: rgba(15,23,42,.86); line-height: 1; }
    .khatmaTag .label{ font-size: 10px; color: rgba(15,23,42,.60); margin-top: -2px; }

    .scene{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      margin-bottom: 16px;
      padding: 14px 16px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.45);
      box-shadow: 0 10px 30px rgba(2,6,23,.05);
      overflow:hidden;
      position:relative;
    }
    .sceneTitle{ margin:0; font-size: 14px; font-weight:900; color: rgba(15,23,42,.90); }
    .svgWrap{ width: 150px; opacity:.95; }

    .heroHeader{ text-align:center; margin-bottom: 18px; padding-top: 10px; }
    .heroMoon{ margin-bottom: 10px; animation: floatMoon 6s ease-in-out infinite; display:flex; justify-content:center; }
    .heroTitle{
      font-family: 'Reem Kufi Fun', sans-serif;
      font-size: clamp(36px, 6vw, 60px);
      font-weight: 800;
      margin: 0;
      background: linear-gradient(90deg, #39e9ae, #0d023f);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .heroSub{ margin-top: 5px; font-size: 14px; color: rgba(255,255,255,.80); }
    @media (max-width: 600px){ .heroTitle{ font-size: 40px; } }
    @keyframes floatMoon{
      0%{ transform: translateY(0px); }
      50%{ transform: translateY(-4px); }
      100%{ transform: translateY(0px); }
    }

    .hide{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="heroHeader">
      <div class="heroMoon">
        <svg viewBox="0 0 200 160" width="140" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
          <defs>
            <linearGradient id="ramadanMoon" x1="20" y1="20" x2="160" y2="140">
              <stop stop-color="#FFD84D"/>
              <stop offset="1" stop-color="#E6B800"/>
            </linearGradient>
          </defs>
          <path
            d="M120 25
               A 55 55 0 1 0 120 135
               A 40 55 0 1 1 120 25 Z"
            fill="url(#ramadanMoon)"
            fill-rule="evenodd"
            clip-rule="evenodd"
            opacity="0.95"
          />
          <circle cx="55" cy="45" r="4" fill="#FFD84D" opacity=".75"/>
          <circle cx="75" cy="70" r="3" fill="#FFD84D" opacity=".55"/>
          <circle cx="160" cy="55" r="4" fill="#FFD84D" opacity=".75"/>
          <circle cx="145" cy="35" r="3" fill="#FFD84D" opacity=".55"/>
        </svg>
      </div>

      <h1 class="heroTitle">Ø§Ù„Ø±ÙÙŠÙ‚ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ</h1>
      <p class="heroSub">Ù…Ù†Ø° 1446 Ø¨Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø´ÙŠØ® Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù‚Ù„</p>

      <div class="pillbar">
        <div class="pill" id="whoPill">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
        <button class="toolbarBtn" id="gotoAppBtn" type="button">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button>
        <button class="toolbarBtn" id="gotoLbBtn" type="button">Ø§Ù„Ù„ÙŠØ¯Ø± Ø¨ÙˆØ±Ø¯</button>
        <button class="toolbarBtn danger hide" id="logoutBtn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <!-- AUTH VIEW -->
    <div class="authBox card" id="authView">
      <div class="cardHead">
        <div>
          <h2 class="cardTitle">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ø³Ù„ÙŠÙ„ Ù„ÙˆÙ„ÙˆÙ‡ ÙˆØ§Ø¨Ø±Ø§Ù‡ÙŠÙ…</h2>
          <p class="cardSub">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ù‹Ø§.</p>
        </div>
      </div>

      <div class="authTabs">
        <button class="tab active" id="tabLogin" type="button">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
        <button class="tab" id="tabRegister" type="button">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      </div>

      <div class="form" id="loginForm">
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø«Ø§Ù„: fay)</label>
          <input id="loginUser" autocomplete="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
        </div>
        <div class="field">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div class="row">
          <button class="authBtn" id="loginBtn" type="button">Ø¯Ø®ÙˆÙ„</button>
        </div>
        <div class="msg" id="loginMsg"></div>
      </div>

      <div class="form hide" id="registerForm">
        <div class="field">
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±</label>
          <input id="regName" placeholder="Ù…Ø«Ø§Ù„: ÙÙŠ" />
        </div>
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ù…ÙŠØ²)</label>
          <input id="regUser" autocomplete="username" placeholder="Ù…Ø«Ø§Ù„: fay" />
        </div>
        <div class="field">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="regPass" type="password" autocomplete="new-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div class="row">
          <button class="authBtn" id="registerBtn" type="button">Ø¥Ù†Ø´Ø§Ø¡</button>
          <span class="hint">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±Ùƒ Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</span>
        </div>
        <div class="msg" id="regMsg"></div>
      </div>
    </div>

    <!-- APP VIEW -->
    <div class="grid hide" id="appView">
      <div class="card">
        <div class="cardHead">
          <div>
            <h2 class="cardTitle" id="helloTitle">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h2>
            <p class="cardSub">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø²Ø¡ Ø¹Ù†Ø¯ Ø¥ÙƒÙ…Ø§Ù„Ù‡ (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø¶ØºØ· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰).</p>
          </div>
        </div>

        <div class="cardBody">
          <div class="scene">
            <div>
              <p class="sceneTitle">Ù‡Ø¯ÙÙ†Ø§ Ø£Ù† ÙŠØ®ØªÙ… ÙƒÙ„ Ù…ØªØ³Ø§Ø¨Ù‚ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</p>
            </div>

            <div class="svgWrap" aria-hidden="true">
              <svg viewBox="0 0 260 160" width="150" height="90" preserveAspectRatio="xMidYMid meet">
                <defs>
                  <linearGradient id="moon2" x1="60" y1="30" x2="200" y2="140" gradientUnits="userSpaceOnUse">
                    <stop stop-color="rgba(212,175,55,.95)"/>
                    <stop offset="1" stop-color="rgba(16,185,129,.9)"/>
                  </linearGradient>
                </defs>
                <path
                  d="M150 25
                     A 55 55 0 1 0 150 135
                     A 40 55 0 1 1 150 25 Z"
                  fill="url(#moon2)"
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  opacity="0.95"
                />
                <circle cx="75" cy="40" r="4" fill="rgba(212,175,55,.7)"/>
                <circle cx="95" cy="65" r="3" fill="rgba(212,175,55,.55)"/>
                <circle cx="210" cy="55" r="4" fill="rgba(212,175,55,.7)"/>
                <circle cx="190" cy="35" r="3" fill="rgba(212,175,55,.55)"/>
              </svg>
            </div>
          </div>

          <div class="progressWrap">
            <div class="pill" id="progressPill">0 / 30</div>
            <div class="pill" id="percentPill">0%</div>
          </div>
          <div class="progressBar" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…">
            <div class="progressFill" id="progressFill"></div>
          </div>

          <div style="height:12px"></div>
          <div class="juzGrid" id="juzGrid"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div>
            <h2 class="cardTitle">Ø§Ù„Ù‚Ø±Ø§Ø¡</h2>
            <p class="cardSub">Ø³Ø§Ø¨Ù‚Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù†Ø©.</p>
          </div>
        </div>
        <div class="cardBody">
          <div class="lbList" id="lbList"></div>
        </div>
      </div>
    </div>

    <!-- LEADERBOARD ONLY VIEW -->
    <div class="card hide" id="lbOnlyView">
      <div class="cardHead">
        <div>
          <h2 class="cardTitle">Ø³Ø§Ø­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</h2>
          <p class="cardSub">ØªØ±ØªÙŠØ¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù…Ø´ØªØ±Ùƒ Ù„Ù„Ø¬Ù…ÙŠØ¹).</p>
        </div>
      </div>
      <div class="cardBody">
        <div class="lbList" id="lbListOnly"></div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast"><div></div></div>

  <!-- âœ… UMD Ø«Ø§Ø¨Øª Ù„Ù„Ù…ØªØµÙØ­ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    // =========================
    // Supabase
    // =========================
    const SUPABASE_URL = "https://hkckofxfmcmkgyxjcxhx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhrY2tvZnhmbWNta2d5eGpjeGh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MjIwNDgsImV4cCI6MjA4NzE5ODA0OH0.NAKVAMY4Kak8EVmYgGeXEKenditGNm-KPcEK95wus4s";

    // âœ… Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø£Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø© loaded
    if (typeof supabase === "undefined" || !supabase.createClient) {
      alert("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Supabase. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø«Ù… Ø£Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.");
      throw new Error("Supabase UMD not loaded");
    }

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =========================
    // Helpers
    // =========================
    const $ = (id) => document.getElementById(id);

    function toast(msg, duration = 2500){
      const t = $("toast");
      t.querySelector("div").textContent = msg;
      t.classList.add("show");
      setTimeout(()=> t.classList.remove("show"), duration);
    }

    function normalizeUsername(u){
      return (u || "").trim().toLowerCase().replace(/\s+/g,"");
    }

    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function showRandomMessage(){
      const messages = [
        "Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠÙƒ ğŸŒ™",
        "Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙƒ âœ¨",
        "ØªÙ‚Ø¨Ù„ Ø§Ù„Ù„Ù‡ Ù‚Ø±Ø§Ø¡ØªÙƒ ğŸ“–",
        "Ù†ÙˆØ± Ø§Ù„Ù„Ù‡ Ù‚Ù„Ø¨Ùƒ ğŸ’›",
        "Ø²Ø§Ø¯Ùƒ Ø§Ù„Ù„Ù‡ Ù‚Ø±Ø¨Ù‹Ø§ ğŸ¤",
        "Ø§Ø³ØªÙ…Ø± ğŸ‘",
        "Ø®Ø·ÙˆØ© Ù…Ø¨Ø§Ø±ÙƒØ© ğŸŒ¿",
        "Ù…Ù…ØªØ§Ø² âœ…",
      ];
      toast(messages[Math.floor(Math.random() * messages.length)]);
    }

    // âœ… Ø¨Ø±ÙŠØ¯ â€œØ´ÙƒÙ„ÙÙ‡ ØµØ­ÙŠØ­â€ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù„ØªÙØ§Ø¯ÙŠ 422 Ø¨Ø³Ø¨Ø¨ email
    function toEmailFromUsername(username){
      return `${username}.family@gmail.com`;
    }

    async function getCurrentUser(){
      const { data, error } = await sb.auth.getUser();
      if (error) return null;
      return data?.user || null;
    }

    async function signOut(){
      await sb.auth.signOut();
    }

    async function ensureProfile(userId, displayName){
      // upsert profile
      const p = await sb.from("profiles").upsert(
        { id: userId, display_name: displayName },
        { onConflict: "id" }
      );
      if (p.error) throw p.error;

      // ensure khatmat row
      const k = await sb.from("khatmat").upsert(
        { user_id: userId, count: 0 },
        { onConflict: "user_id" }
      );
      if (k.error) throw k.error;
    }

    async function fetchMyProgress(userId){
      const { data, error } = await sb.from("progress").select("juz").eq("user_id", userId);
      if(error) return [];
      return (data || []).map(x => x.juz);
    }

    async function fetchAllForLeaderboard(){
      const [profilesRes, progressRes, khatmatRes] = await Promise.all([
        sb.from("profiles").select("id, display_name"),
        sb.from("progress").select("user_id, juz"),
        sb.from("khatmat").select("user_id, count")
      ]);

      return {
        profiles: profilesRes.data || [],
        progress: progressRes.data || [],
        khatmat: khatmatRes.data || []
      };
    }

    async function incrementKhatmaAndReset(userId){
      const { data: kh, error: khErr } = await sb
        .from("khatmat")
        .select("count")
        .eq("user_id", userId)
        .maybeSingle();

      const current = kh?.count ?? 0;

      if(!khErr){
        const up = await sb.from("khatmat").upsert(
          { user_id: userId, count: current + 1, updated_at: new Date().toISOString() },
          { onConflict: "user_id" }
        );
        if (up.error) throw up.error;
      }

      const del = await sb.from("progress").delete().eq("user_id", userId);
      if (del.error) throw del.error;
    }

    // =========================
    // UI Elements
    // =========================
    const authView = $("authView");
    const appView = $("appView");
    const lbOnlyView = $("lbOnlyView");

    const whoPill = $("whoPill");
    const logoutBtn = $("logoutBtn");
    const gotoAppBtn = $("gotoAppBtn");
    const gotoLbBtn = $("gotoLbBtn");

    const tabLogin = $("tabLogin");
    const tabRegister = $("tabRegister");
    const loginForm = $("loginForm");
    const registerForm = $("registerForm");
    const loginMsg = $("loginMsg");
    const regMsg = $("regMsg");

    const helloTitle = $("helloTitle");
    const progressPill = $("progressPill");
    const percentPill = $("percentPill");
    const progressFill = $("progressFill");
    const juzGrid = $("juzGrid");

    const lbList = $("lbList");
    const lbListOnly = $("lbListOnly");

    let currentUser = null;

    function showAuth(){
      authView.classList.remove("hide");
      appView.classList.add("hide");
      lbOnlyView.classList.add("hide");
    }
    function showApp(){
      authView.classList.add("hide");
      appView.classList.remove("hide");
      lbOnlyView.classList.add("hide");
    }
    function showLbOnly(){
      authView.classList.add("hide");
      appView.classList.add("hide");
      lbOnlyView.classList.remove("hide");
    }

    // =========================
    // Tabs
    // =========================
    tabLogin.onclick = () => {
      tabLogin.classList.add("active");
      tabRegister.classList.remove("active");
      loginForm.classList.remove("hide");
      registerForm.classList.add("hide");
      loginMsg.classList.remove("show");
      regMsg.classList.remove("show");
    };
    tabRegister.onclick = () => {
      tabRegister.classList.add("active");
      tabLogin.classList.remove("active");
      registerForm.classList.remove("hide");
      loginForm.classList.add("hide");
      loginMsg.classList.remove("show");
      regMsg.classList.remove("show");
    };

    // =========================
    // Auth Actions (FIXED)
    // =========================
    $("registerBtn").onclick = async () => {
      const btn = $("registerBtn");
      btn.disabled = true;

      try{
        regMsg.classList.remove("show");
        loginMsg.classList.remove("show");

        const displayName = ($("regName").value || "").trim();
        const username = normalizeUsername($("regUser").value || "");
        const pass = $("regPass").value || "";

        // âœ… ØªØ­Ù‚Ù‚ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
        const okUser = /^[a-z0-9._-]{3,20}$/.test(username);

        if(!displayName || !username){
          regMsg.textContent = "Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø± ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….";
          regMsg.classList.add("show");
          return;
        }
        if(!okUser){
          regMsg.textContent = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ/Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª (Ù…Ø«Ø§Ù„: fay1 Ø£Ùˆ abdullah_2).";
          regMsg.classList.add("show");
          return;
        }
        if(pass.length < 6){
          regMsg.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.";
          regMsg.classList.add("show");
          return;
        }

        const email = toEmailFromUsername(username);

        const { data, error } = await sb.auth.signUp({ email, password: pass });

        if(error){
          console.error("SIGNUP ERROR:", error);
          regMsg.textContent = `ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ${error.message || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}`;
          regMsg.classList.add("show");
          return;
        }

        if (data?.user) {
          try{
            await ensureProfile(data.user.id, displayName);
          } catch (e) {
            console.error("PROFILE ERROR:", e);
            regMsg.textContent = "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ Ù„ÙƒÙ† ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ. ØªØ£ÙƒØ¯ Ù…Ù† Ø³ÙŠØ§Ø³Ø§Øª RLS Ø«Ù… Ø¬Ø±Ù‘Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
            regMsg.classList.add("show");
            return;
          }
        }

        regMsg.textContent = "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ… Ø§Ù„Ø¢Ù† Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ.";
        regMsg.classList.add("show");
        toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ğŸŒ™");

        tabLogin.click();
        $("loginUser").value = username;
        $("loginPass").value = "";

      } finally {
        btn.disabled = false;
      }
    };

    $("loginBtn").onclick = async () => {
      const btn = $("loginBtn");
      btn.disabled = true;

      try{
        loginMsg.classList.remove("show");
        regMsg.classList.remove("show");

        const username = normalizeUsername($("loginUser").value || "");
        const pass = $("loginPass").value || "";

        if(!username || !pass){
          loginMsg.textContent = "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
          loginMsg.classList.add("show");
          return;
        }

        const email = toEmailFromUsername(username);

        const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });

        if(error){
          console.error("LOGIN ERROR:", error);
          loginMsg.textContent = error.message || "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
          loginMsg.classList.add("show");
          return;
        }

        toast("Ø£Ù‡Ù„Ù‹Ø§ ÙˆØ³Ù‡Ù„Ù‹Ø§ ğŸŒ™");
        currentUser = data?.user?.id || null;
        await renderAll();
        showApp();

      } finally {
        btn.disabled = false;
      }
    };

    logoutBtn.onclick = async () => {
      await signOut();
      currentUser = null;
      toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
      await renderAll();
      showAuth();
    };

    // =========================
    // Top Navigation
    // =========================
    gotoAppBtn.onclick = async () => {
      const user = await getCurrentUser();
      if(!user){
        showAuth();
        toast("Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ù‹Ø§");
        return;
      }
      showApp();
      await renderAll();
    };

    gotoLbBtn.onclick = async () => {
      showLbOnly();
      await renderLeaderboard(lbListOnly, null);
    };

    // =========================
    // Juz Grid
    // =========================
    function buildJuzGrid(){
      juzGrid.innerHTML = "";
      for(let i=1;i<=30;i++){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "juzBtn";
        btn.dataset.juz = String(i);
        btn.innerHTML = `
          <div class="small">Ø§Ù„Ø¬Ø²Ø¡</div>
          <div class="num">${i}</div>
        `;
        btn.onclick = () => toggleJuz(i);
        juzGrid.appendChild(btn);
      }
    }

    async function toggleJuz(juz){
      const user = await getCurrentUser();
      if(!user){
        toast("Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ù‹Ø§");
        showAuth();
        return;
      }
      const userId = user.id;

      const { data: existing } = await sb
        .from("progress")
        .select("juz")
        .eq("user_id", userId)
        .eq("juz", juz)
        .maybeSingle();

      if(!existing){
        const ins = await sb.from("progress").insert({ user_id: userId, juz });
        if(!ins.error) showRandomMessage();
      } else {
        await sb.from("progress").delete().eq("user_id", userId).eq("juz", juz);
        toast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯");
      }

      const my = await fetchMyProgress(userId);
      if(my.length === 30){
        await incrementKhatmaAndReset(userId);
        toast("Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡! ØªÙ…Ù‘Øª Ø§Ù„Ø®ØªÙ…Ø© ğŸ‰ğŸŒ™ ÙˆØ¨Ø¯Ø£Øª Ø®ØªÙ…Ø© Ø¬Ø¯ÙŠØ¯Ø©", 5000);
      }

      await renderAll();
    }

    // =========================
    // Render Progress
    // =========================
    async function renderProgress(){
      const user = await getCurrentUser();
      if(!user) return;

      const userId = user.id;

      const [progressArr, profRes, khRes] = await Promise.all([
        fetchMyProgress(userId),
        sb.from("profiles").select("display_name").eq("id", userId).maybeSingle(),
        sb.from("khatmat").select("count").eq("user_id", userId).maybeSingle()
      ]);

      const name = profRes.data?.display_name || "Ù…Ø³ØªØ®Ø¯Ù…";
      const khatmatCount = khRes.data?.count ?? 0;

      helloTitle.textContent = `Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© â€” Ø£Ù‡Ù„Ù‹Ø§ ÙŠØ§ ${name} ğŸŒ™`;

      const done = progressArr.length;
      const pct = Math.round((done/30)*100);

      progressPill.textContent = `${done} / 30`;
      percentPill.textContent = `${pct}%`;
      progressFill.style.width = `${clamp(pct,0,100)}%`;

      const doneSet = new Set(progressArr);
      [...juzGrid.querySelectorAll(".juzBtn")].forEach((btn)=>{
        const j = Number(btn.dataset.juz);
        btn.classList.toggle("done", doneSet.has(j));
      });
    }

    // =========================
    // Leaderboard (works without login)
    // =========================
    async function renderLeaderboard(container, highlightUser){
      const all = await fetchAllForLeaderboard();
      const profiles = all.profiles;
      const progress = all.progress;
      const khatmat = all.khatmat;

      const countMap = new Map();
      for(const row of progress){
        countMap.set(row.user_id, (countMap.get(row.user_id) || 0) + 1);
      }

      const khMap = new Map();
      for(const row of khatmat){
        khMap.set(row.user_id, Number(row.count || 0));
      }

      const rows = profiles.map(p => {
        const count = countMap.get(p.id) || 0;
        const kh = khMap.get(p.id) || 0;
        return { userId: p.id, displayName: p.display_name || "Ù…Ø³ØªØ®Ø¯Ù…", count, khatmat: kh };
      });

      rows.sort((a,b)=>
        b.khatmat - a.khatmat ||
        b.count - a.count ||
        a.displayName.localeCompare(b.displayName, "ar")
      );

      container.innerHTML = "";

      if(rows.length === 0){
        container.innerHTML = `<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø¨Ø¹Ø¯.</div>`;
        return;
      }

      rows.forEach((r, idx)=>{
        const el = document.createElement("div");
        el.className = "lbRow";

        const isMe = highlightUser && r.userId === highlightUser;
        const pct = Math.round((r.count/30)*100);
        const medal = idx===0 ? "ğŸ¥‡" : idx===1 ? "ğŸ¥ˆ" : idx===2 ? "ğŸ¥‰" : "â­";

        el.style.borderColor = isMe ? "rgba(16,185,129,.35)" : "rgba(255,255,255,.18)";
        el.style.background = isMe ? "rgba(16,185,129,.10)" : "rgba(255,255,255,.5)";

        el.innerHTML = `
          <div class="lbLeft">
            <div class="rank">${idx+1}</div>
            <div>
              <div class="name">${medal} ${escapeHtml(r.displayName)}${isMe ? " (Ø£Ù†Øª)" : ""}</div>
              <div class="meta">${r.count} / 30 â€” ${pct}%</div>
            </div>
          </div>

          <div class="khatmaTag" title="Ø¹Ø¯Ø¯ Ø§Ù„Ø®ØªÙ…Ø§Øª">
            <div class="crown">ğŸ‘‘</div>
            <div class="num">${r.khatmat}</div>
            <div class="label">Ø®ØªÙ…Ø§Øª</div>
          </div>
        `;

        container.appendChild(el);
      });
    }

    // =========================
    // Top pill
    // =========================
    async function renderTopPill(){
      const user = await getCurrentUser();
      if(!user){
        currentUser = null;
        whoPill.textContent = "ØºÙŠØ± Ù…Ø³Ø¬Ù„";
        logoutBtn.classList.add("hide");
        return;
      }

      currentUser = user.id;
      logoutBtn.classList.remove("hide");

      const { data: prof } = await sb
        .from("profiles")
        .select("display_name")
        .eq("id", user.id)
        .maybeSingle();

      whoPill.textContent = `Ù…Ø³Ø¬Ù„: ${prof?.display_name || "Ù…Ø³ØªØ®Ø¯Ù…"}`;
    }

    // =========================
    // Render all
    // =========================
    async function renderAll(){
      await renderTopPill();
      await renderLeaderboard(lbList, currentUser);
      await renderLeaderboard(lbListOnly, null);

      if(!appView.classList.contains("hide")){
        if(!currentUser){
          showAuth();
          return;
        }
        await renderProgress();
      }
    }

    // =========================
    // Init
    // =========================
    (async function init(){
      buildJuzGrid();

      sb.auth.onAuthStateChange(async () => {
        await renderAll();
        const user = await getCurrentUser();
        if(user) showApp();
        else showAuth();
      });

      const user = await getCurrentUser();
      if(user) showApp();
      else showAuth();

      await renderAll();
    })();
  </script>
</body>
</html>